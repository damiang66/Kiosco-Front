<div class="container mt-4">
  <h3 class="text-center">{{ idVenta ? 'Editar Venta' : 'Nueva Venta' }}</h3>

  <!-- Fecha -->
  <div hidden class="mb-3">
    <label>Fecha</label>
    <input 
      type="date" 
      [(ngModel)]="venta.fecha" 
      class="form-control" 
      placeholder="Fecha" 
    />
  </div>

  <!-- Botón abrir modal -->
  <div class="d-flex justify-content-between mb-3">
    <h5>Productos</h5>
    <button class="btn btn-success" (click)="abrirModal()">Buscar producto</button>
  </div>

  <!-- Tabla detalles -->
  <table class="table table-bordered text-center">
    <thead class="table-dark">
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Subtotal</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let det of venta.detalles; let i = index">
        <td>{{ det.producto.descripcion }}</td>
        <td>{{ det.cantidad }}</td>
        <td>{{ det.precioUnitario | currency:'ARS' }}</td>
        <td>{{ det.subtotal | currency:'ARS' }}</td>
        <td>
          <button class="btn btn-danger btn-sm" (click)="eliminarDetalle(i)">X</button>
        </td>
      </tr>
    </tbody>
  </table>

  <h5 class="text-end mt-3">Total: {{ venta.total | currency:'ARS' }}</h5>

  <div class="text-center mt-4">
    <button class="btn btn-primary me-2" (click)="guardarVenta()">Siguiente</button>
    <button class="btn btn-secondary" routerLink="/ventas">Cancelar</button>
  </div>

<!-- Modal de búsqueda de producto -->
  <ng-template #modalProductos let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Buscar Producto</h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
      <input
        type="text"
        class="form-control mb-3"
        placeholder="Buscar por código o descripción"
        [(ngModel)]="terminoBusqueda"
        (input)="buscarProducto()"
      />

      <table class="table table-hover text-center">
        <thead>
          <tr>
            <th>Código</th>
            <th>Descripción</th>
            <th>Stock</th>
            <th>Precio Venta</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of productosFiltrados">
            <td>{{ p.codigo }}</td>
            <td>{{ p.descripcion }}</td>
            <td>{{ p.cantidad }}</td>
            <td>{{ p.precioVenta | currency:'ARS' }}</td>
            <td>
              <button class="btn btn-sm btn-primary" (click)="seleccionarProducto(p, modal)">Seleccionar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-template>
</div>

<!-- Modal de Pago -->
<ng-template #modalPago let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Registrar Pago</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <div class="mb-3">
      <label for="montoCliente" class="form-label">Monto entregado por el cliente</label>
      <input 
        id="montoCliente"
        type="number"
        class="form-control"
        [(ngModel)]="montoCliente"
        (input)="calcularVuelto()"
        placeholder="Ingrese el monto entregado"
        min="0"
      />
    </div>

    <div *ngIf="montoCliente >= 0" class="alert" 
         [ngClass]="{'alert-info': vuelto >= 0, 'alert-danger': vuelto < 0}">
      <p><strong>Total a pagar:</strong> {{ venta.total | currency:'ARS' }}</p>
      <p><strong>Vuelto:</strong> 
        <span *ngIf="vuelto >= 0">{{ vuelto | currency:'ARS' }}</span>
        <span *ngIf="vuelto < 0">Faltan {{ (vuelto * -1) | currency:'ARS' }}</span>
      </p>
    </div>
  </div>

  <div class="modal-footer d-flex justify-content-between">
    <button class="btn btn-secondary" (click)="modal.dismiss()">Cancelar</button>
    <button class="btn btn-success" (click)="guardarVentaDesdeModal(modal)">
      Confirmar y Guardar Venta
    </button>
  </div>
</ng-template>
